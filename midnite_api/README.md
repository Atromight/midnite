# Midnite API

A [**FastAPI**](https://fastapi.tiangolo.com/) service that records and monitors user financial transactions and raises alerts based on predefined rules.


---

## Table of Contents
- [Description](#description)
- [Alert Codes](#alert-codes)
- [Endpoints](#endpoints)
  - [POST /event](#post-event)
- [Running Locally](#running-locally)
  - [Prerequisites](#prerequisites)
  - [Setup](#setup)
  - [Run the App](#run-the-app)
  - [Testing](#testing)


---

## Description

Midnite API enables tracking of user events (financial transactions) such as **withdrawals** and **deposits**, and emits alerts when specific patterns are detected. These alerts help monitor user behavior in real-time.

---

## Alert Codes

The system currently supports the following alert triggers:

| Code     | Trigger Condition                                                 |
|----------|-------------------------------------------------------------------|
| `1100`   | A single withdrawal of more than 100                              |
| `30`     | 3 consecutive withdrawals                                         |
| `300`    | 3 consecutive increasing deposits (ignoring withdrawals)          |
| `123`    | Total deposit amount in the last 30 seconds is over 200           |

---

## Endpoints

### POST `/event`

Creates and stores a new event (deposit or withdrawal) and returns applicable alert codes.

#### Request Body Example

```json
{
  "type": "withdraw",
  "amount": 162.0,
  "user_id": 13,
  "t": 2
}
```

#### Response Body Example

```json
{
  "alert": true,
  "alert_codes": [1100],
  "user_id": 13,
}
```

## Running Locally

### Prerequisites

This app requires [Python](https://www.python.org/downloads/) version 3.11+.
It also requires [poetry](https://python-poetry.org/) installed.
One way to install poetry is:
```
curl -sSL https://install.python-poetry.org | python3 -
```

### Setup

First, you need to clone the repo:
```
git clone https://github.com/Atromight/midnite.git
cd midnite/midnite_api
```

Then, install dependencies:
```
poetry install
```

### Run the app

Use Makefile to run the application locally.
```
make run
```

Once the app is running, you can interact with the API at http://localhost:5000/

For example, if you want to make a POST request and record a new event while the app is running, 
you can do it from your terminal by using the following curl command:
```
curl -XPOST http://127.0.0.1:5000/event -H 'Content-Type: application/json' -d '{"type": "withdraw", "amount": "162.00", "user_id": 13, "t": 2}'
```

You can also view the autogenerated API documentation in the Swagger UI at http://localhost:5000/docs


### Testing

You can also use Makefile to run some unit tests:
```
make test
```
